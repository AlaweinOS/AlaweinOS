apiVersion: v1
kind: ServiceAccount
metadata:
  name: mezan-atlas-sa
  namespace: mezan-atlas
  labels:
    app.kubernetes.io/name: mezan-atlas
    app.kubernetes.io/component: serviceaccount
    app.kubernetes.io/part-of: mezan
  annotations:
    # For AWS IRSA (IAM Roles for Service Accounts)
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/mezan-atlas-role
    # For GKE Workload Identity
    iam.gke.io/gcp-service-account: mezan-atlas@PROJECT_ID.iam.gserviceaccount.com
automountServiceAccountToken: true

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: mezan-atlas-role
  namespace: mezan-atlas
  labels:
    app.kubernetes.io/name: mezan-atlas
    app.kubernetes.io/component: role
    app.kubernetes.io/part-of: mezan
rules:
# ConfigMaps and Secrets access
- apiGroups: [""]
  resources: ["configmaps", "secrets"]
  verbs: ["get", "list", "watch"]
# Pod operations for job management
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["pods/exec"]
  verbs: ["create"]
# Service discovery
- apiGroups: [""]
  resources: ["services", "endpoints"]
  verbs: ["get", "list", "watch"]
# Job management
- apiGroups: ["batch"]
  resources: ["jobs", "cronjobs"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
# Metrics access
- apiGroups: ["metrics.k8s.io"]
  resources: ["pods", "nodes"]
  verbs: ["get", "list"]
# Events for auditing
- apiGroups: [""]
  resources: ["events"]
  verbs: ["get", "list", "watch", "create"]
# Lease for leader election
- apiGroups: ["coordination.k8s.io"]
  resources: ["leases"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: mezan-atlas-rolebinding
  namespace: mezan-atlas
  labels:
    app.kubernetes.io/name: mezan-atlas
    app.kubernetes.io/component: rolebinding
    app.kubernetes.io/part-of: mezan
subjects:
- kind: ServiceAccount
  name: mezan-atlas-sa
  namespace: mezan-atlas
roleRef:
  kind: Role
  name: mezan-atlas-role
  apiGroup: rbac.authorization.k8s.io

---
# ClusterRole for cross-namespace operations (optional)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: mezan-atlas-clusterrole
  labels:
    app.kubernetes.io/name: mezan-atlas
    app.kubernetes.io/component: clusterrole
    app.kubernetes.io/part-of: mezan
rules:
# Node information for scheduling decisions
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["get", "list", "watch"]
# Storage information
- apiGroups: ["storage.k8s.io"]
  resources: ["storageclasses"]
  verbs: ["get", "list", "watch"]
# CRD access (if using custom resources)
- apiGroups: ["apiextensions.k8s.io"]
  resources: ["customresourcedefinitions"]
  verbs: ["get", "list", "watch"]
# Ingress information
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses", "networkpolicies"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: mezan-atlas-clusterrolebinding
  labels:
    app.kubernetes.io/name: mezan-atlas
    app.kubernetes.io/component: clusterrolebinding
    app.kubernetes.io/part-of: mezan
subjects:
- kind: ServiceAccount
  name: mezan-atlas-sa
  namespace: mezan-atlas
roleRef:
  kind: ClusterRole
  name: mezan-atlas-clusterrole
  apiGroup: rbac.authorization.k8s.io

---
# For monitoring access
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: mezan-atlas-metrics-reader
  labels:
    app.kubernetes.io/name: mezan-atlas
    app.kubernetes.io/component: metrics-reader
rules:
- apiGroups: ["metrics.k8s.io"]
  resources: ["pods", "nodes"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["pods", "nodes", "nodes/stats"]
  verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: mezan-atlas-metrics-reader-binding
  labels:
    app.kubernetes.io/name: mezan-atlas
    app.kubernetes.io/component: metrics-reader-binding
subjects:
- kind: ServiceAccount
  name: mezan-atlas-sa
  namespace: mezan-atlas
roleRef:
  kind: ClusterRole
  name: mezan-atlas-metrics-reader
  apiGroup: rbac.authorization.k8s.io